version: '3.8'

services:
  unifi-ldap-sync:
    build: .
    container_name: unifi-ldap-sync
    restart: unless-stopped
    
    ports:
      - "389:389"
    
    volumes:
      - ldap_data:/var/lib/ldap
      - ldap_config:/etc/ldap/slapd.d
      - ./secrets:/run/secrets:ro
      
    environment:
      - UNIFI_DOMAIN=${UNIFI_DOMAIN}
      - SITE_NAME=${SITE_NAME}
      - LDAP_BASE_DN=${LDAP_BASE_DN}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LDAP_ROOTPW_FILE=/run/secrets/ldap_rootpw
    
    secrets:
      - ldap_rootpw
      - unifi_token
      
    healthcheck:
      test: ["CMD-SHELL", "timeout 5 bash -c 'echo status | nc -w2 -u localhost 389' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s  # Больше времени на init

secrets:
  ldap_rootpw:
    file: ./secrets/ldap_rootpw 
  unifi_token:
    file: ./secrets/unifi_token 

volumes:
  ldap_data:
  ldap_config:
